---
title: "Correlation Matrices"
author: "Felix EÃŸer"
date: "4/26/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
Often it is of interest to get the correlations of several variables among each other and not only one correlation of one pair of variables. These correlations are often arranged in a correlation matrix. 

A correlation matrix is a $p \times p$ matrix, where $p$ denotes the number of variables. Within a correlation matrix
- correlations on the principal diagonal represent the correlation of the variable with itself which equals the variances of the variable
- correlations on the off-diagonals are correlations between variables

Usually, correlation matrices are presented in tables accompanying other descriptive statistics like the means and standard deviations of the $p$ variables. In addition, it is possible to visualize correlation matrices in several ways.

As several correlations are calculated and often tested for significance, it is often important to adjust the $p$-values of the significance tests because multiple tests are conducted. 

In the following, only the pearson correlation is used, but it is possible for all other correlations too (link to Correlation file). The pearson correlation is the most used correlation coefficient and is consequently supported the most. Therefore, convenient packages are shown as well as calculation *by hand* in a loop (link to loops) in order to obtain results for less supported correlation measures.

# Packages and data

Load the necessary packages:
```{r packages, message=FALSE}
library(correlation) # plot of correlations
library(corrplot) # plots for correlation matrix
library(kableExtra) # table output
library(qgraph) # network visualization
library(RColorBrewer) # color palettes
library(skimr) # descriptive data analysis
library(tidyverse) # data wrangling, plotting, etc.
```


Load the data used in this section and output the descriptive statistics.
```{r data}
# Load data
data_arrest <- datasets::USArrests

# Get descriptives of data
skim(data_arrest)
```

This datasets contains violent crime rates in the U.S. by state. The values represent the number of people in arrest per 100,000 residents by arrest reason as well as the percentage of the urban population. 



# Correlation matrix

There are a lot of possibilities and packages to calculate correlation matrices. Here, three approaches are shown:

1. Correlation matrix using the `{stats}` package
2. Correlation matrix using the `{correlation}` package
3. Manual creation of a correlation matrix


## Correlation matrix using the built-in `{stats}` package


Correlations built upon the covariance of two variables (see link to Correlation file). For completeness, the calculation of a covariance matrix with the `cov()` function of the `{stats}` package is provided too. 

```{r cov-matrix}
# Calculate and output covariance matrix
cov(data_arrest)
```

As easily as calculating covariance matrices, it is possible to create correlation matrices with the `{stats}` package. However, only the pearson, kendall and spearman correlation measures are possible to conduct, specifying the `method` argument. 

```{r cor-matrix-stats}
# Calculate correlation matrix with stats package
cor_stats <- cor(data_arrest,
                 method = "pearson") # default; kendall or spearman possible

# Output correlation matrix
cor_stats
```

As can be seen, the correlation matrix does not provide $p$-values in order to assess the significance of the correlation. Logically, other packages have been developed in order to overcome this shortage. 

## Correlation matrix using the `{correlation}` package

The `correlation()` function of the `{correlation}` package provides several correlation measures, specified by the `method` argument (see also link to Correlation file).

```{r cor-matrix-correlation}
# Calculate correlations with correlation package
cor_correlation <- correlation(data_arrest,
                               method = "pearson", # default: pearson
                               p_adjust = "none") # default: holm

# Get full correlation as matrix
summary_correlation <- summary(cor_correlation,
                               redundant = TRUE) # default: false, get matrix 
                                                 # instead of long data form

# Output full correlation matrix
summary_correlation

```

The resulted output shows the correlation matrix with stars, indicating the level on which the correlation is significant.


## Manual creation of a correlation matrix

Although the manual creation of a correlation matrix is more cumbersome, this procedure is sometimes necessary because there is no function available that creates a correlation matrix with corresponding $p$-values. An example is the function `cor.test()` of the built-in `{stats}` package. This function calculates the pearson correlation coefficient and the associated $p$-value but cannot produce a correlation matrix. The function `cor()` of the `{stats}` package can produce a correlation matrix but lacks the calculation of $p$-values. Several packages (e.g., `{correlation}`, `{Hmisc}`) are able to overcome this problem, however, when a rarely used coefficient is needed, the following approach can be used.

In this approach the pearson correlation is calculated between the variables of the `data_arrest` dataset. This happens in the following steps:

1. Subset variables of interest from dataset
2. Create empty matrices (`NA` values) for correlation coefficients and $p$-values
3. Run nested loop populating the correlation and $p$-value matrix 


```{r cor-matrix-manual}
# 1. Create dataset only with variables their correlation is of interest ----
data_arrest <- data_arrest # here no subset necessary; included for completeness

# 2. Create matrix with NA values for correlation coefficients ----
cor_mat <- matrix(nrow = ncol(data_arrest), # pxp matrix with NA values
                  ncol = ncol(data_arrest), # p = number of variables in df
                  dimnames = list(colnames(data_arrest), colnames(data_arrest)))
# Create matrix with NA values for p-values
p_mat <- cor_mat

# 3. Nested loop to populate matrix entries ----
for (i in seq(ncol(data_arrest))) { # first loop over variables
  for (j in seq(ncol(cor_mat))) { # second loop over variables
    
    # Create temporary correaltion coefficient with p-value
    cor_temp <- cor.test(data_arrest[,i], data_arrest[,j]) 
    # Extract correlation coefficient and p-value
    cor_mat[i,j] <- cor_temp$estimate
    p_mat[i,j] <- cor_temp$p.value
    
  }
}
```

Depending on the correlation function of interest, the content of the nested loop has to be altered. 

The correlation coefficients are stored in the object `cor_mat`.

```{r cor-matrix-manual-cor}
# Output correlation matrix
cor_mat
```

The corresponding $p$-values are stored in the object `p_mat`. These $p$-values are not adjusted. See section $p$-value adjustment (insert link).

```{r cor-matrix-manual-p}
# Output of corresponding p-values
p_mat
```



# $p$-value adjustment

There are a lot of packages providing $p$-value adjustment, like `{correlation}`, `{TestCor}` or `{psych}`. Here, $p$-value adjustment is shown via the `{correlation}` package as it supports a lot of different correlation measures. Additionally, a manual way of adjusting $p$-values is shown in order to have a versatile and fail-safe approach if an correlation measure of interest is not supported. 

The available adjustment methods for the following presented procedures with the `{correlation}` package and the `p.adjust()` function of the `{stats}` package are:

1. bonferroni
2. holm
3. hochberg
4. hommel
5. BH or fdr 
6. BY
8. somers (only in the `{correlation}` package)


For the theory of $p$-value adjustment and which adjustment procedure to choose, have a look at the file `Multiple_Testing` (insert link to multiple testing).


## $p$-value adjustment with the `{correlation}` package

The `correlation()` function of the `{correlation}` package provides several options to adjust the p-values for multiple testing. 

```{r p-adj-correlation-1}
# Get correlations with corrected p-values
padj_correlation <- correlation(data_arrest,
                                p_adjust = "BH") # default
padj_correlation

# Get summary object of correlations for matrix format
summary_padj_correlation <- summary(padj_correlation,
                                    redundant = TRUE) # get full matrix

# Output correlation matrix
summary_padj_correlation
```
You could also output the object `padj_correlation` which will output a tabular format where each row represents a correlation that will show also the adjusted $p$-values. 

For the matrix of adjusted $p$-values, execute the following. 

```{r p-adj-correlation-2}
# Get matrix of adjusted p-values from correlation package
attr(summary_padj_correlation, "p")
```


## Manual $p$-value adjustment
# Tables
# Visualization
## Symbolic number encoding
## Correlogram
## Network graph for Correlations
